name: Update flake.lock

on:
  workflow_dispatch:  # Manual trigger for nix flake update
    inputs:
      update_deps:
        description: 'Update Nix dependencies to latest versions'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'uv.lock'
      - 'pyproject.toml'
    branches:
      - 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need parent commit to check if flake.lock changed

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update flake.lock
        run: |
          if [ "${{ github.event.inputs.update_deps }}" = "true" ]; then
            echo "Updating Nix dependencies to latest versions..."
            nix flake update --commit-lock-file
          else
            echo "Generating flake.lock from current flake.nix..."
            nix flake lock --commit-lock-file
          fi

      - name: Check if flake.lock changed
        id: check_changes
        run: |
          if git diff --quiet HEAD~1 flake.lock 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to flake.lock"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "flake.lock has changed"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update flake.lock after uv.lock changes"
          title: "Update flake.lock for Nix environment"
          # Create PR against the branch that triggered the workflow
          # For push events: PR targets the branch that was pushed to
          # For manual triggers: PR targets the branch selected in the GitHub UI
          # Without explicit base, the action defaults to the repository's default branch (main)
          base: ${{ github.ref_name }}
          body: |
            ## Automated flake.lock update

            This PR updates `flake.lock` in response to changes in `uv.lock` or `pyproject.toml`.

            ### Changes
            - Ensures `flake.lock` is consistent with current `flake.nix`
            - Keeps Nix development environment in sync with Python dependencies
            - Does NOT update nixpkgs/uv2nix versions (use manual trigger for that)

            ### Review
            - Check that the flake.lock diff looks reasonable
            - Merge when ready

            This is an automated PR generated by GitHub Actions.
          branch: auto-update-flake-lock-${{ github.ref_name }}
          delete-branch: true
          labels: dependencies,nix,automated
