name: Update flake.lock

on:
  workflow_dispatch:  # Manual trigger for nix flake update
    inputs:
      update_deps:
        description: 'Update Nix dependencies to latest versions'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'flake.nix'
    branches:
      - 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update flake.lock
        id: check_changes
        run: |
          # Record current HEAD to detect if --commit-lock-file creates a commit
          BEFORE_HEAD=$(git rev-parse HEAD)

          if [ "${{ github.event.inputs.update_deps }}" = "true" ]; then
            echo "Updating Nix dependencies to latest versions..."
            nix flake update --commit-lock-file
          else
            echo "Generating flake.lock from current flake.nix..."
            nix flake lock --commit-lock-file
          fi

          # Check if a commit was created by comparing HEAD
          AFTER_HEAD=$(git rev-parse HEAD)
          if [ "$BEFORE_HEAD" != "$AFTER_HEAD" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "flake.lock has changed - commit created"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to flake.lock - no commit needed"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update flake.lock after uv.lock changes"
          title: "Update flake.lock for Nix environment"
          # Create PR against the branch that triggered the workflow
          # For push events: PR targets the branch that was pushed to
          # For manual triggers: PR targets the branch selected in the GitHub UI
          # Without explicit base, the action defaults to the repository's default branch (main)
          base: ${{ github.ref_name }}
          body: |
            ## Automated flake.lock update

            This PR updates `flake.lock` in response to changes in `flake.nix`.

            ### Changes
            - Ensures `flake.lock` is consistent with current `flake.nix`
            - Locks Nix dependencies (nixpkgs, uv2nix, pyproject-nix)
            - Does NOT update to newer versions of dependencies (use manual trigger with update_deps for that)

            ### Review
            - Check that the flake.lock diff looks reasonable
            - Merge when ready

            This is an automated PR generated by GitHub Actions.
          branch: auto-update-flake-lock-${{ github.ref_name }}
          delete-branch: true
          labels: dependencies,nix,automated
